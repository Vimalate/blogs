---
title: pnpm
date: 2023-02-16
tags:
 - 技巧
categories: 
 - 其他
---

## pnpm 是什么

pnpm 为 performant npm 的简称，意为高性能的 npm

pnpm 主要有以下优点:

- 快速: pnpm 比其他包管理工具快两倍;
- 高效: node_modules 中的文件链接自特定的内容寻址存储库;
- 支持monorepo: pnpm 内置了对存储库中的多个包的支持;
- 严格: pnpm 默认创建一个非平铺的 node_modules,因此代码不能访问任意包;


## 快速入门

安装 pnpm 

```shell
npm install -g pnpm
```


新建文件夹作为工作区 ，例如我这里 ```shuge-ui```

- 初始化
```
pnpm init 
```

文件夹下生成了 ```package.json```


根目录下新建 pnpm-workspace.yaml

```
packages:
  # all packages in direct subdirs of packages/
  - 'packages/*'
  # all packages in subdirs of components/
  - 'components/**'
  # exclude packages that are inside test directories
  - '!**/test/**'
```


- 安装包到根目录

```shell
# 安装到工作区根目录并且是开发依赖
pnpm install 包名 -D -w
```

- 安装包到子目录 --filter
- 
利用--filter 可以直接在根目录指定安装依赖到子包，当然--filter还有其他功能。

```shell
# --filter 或者 -F <package_name> 可以在指定目录 package 执行任务
pnpm i -F demo       # 在根目录中向demo目录安装所有依赖
pnpm i vue -F demo   # 在根目录中向demo目录安装vue
```

## 软链接与硬链接

[软链接和硬链接](https://zhuanlan.zhihu.com/p/442133074)

pnpm 使用软链接和硬链接两种方式的原因是为了优化安装和升级依赖包的速度和空间占用。

软链接是一种特殊的文件，它像一个指针一样指向另一个文件或目录，而不是实际的拷贝。当使用软链接安装依赖包时，pnpm 只需在全局缓存中保存一份依赖包副本，然后在项目中创建软链接指向这个副本。这样，当多个项目使用同一个依赖包时，各个项目之间共享同一个副本，节省了磁盘空间。

硬链接是一种特殊的文件链接，它与软链接类似，但不同的是硬链接不是指针，而是与原始文件共享同一个 inode，即实际上是同一个文件。当使用硬链接安装依赖包时，pnpm 可以在全局缓存中创建多个硬链接，每个硬链接指向同一个依赖包副本。这种方式可以更快地复制和升级依赖包，因为每个硬链接都指向同一个 inode，所以只需更新一次就能同时更新所有硬链接。

综上所述，pnpm 使用软链接和硬链接两种方式可以提高依赖包的安装和升级速度，同时节省磁盘空间。

## pnpm为什么不只使用软链接
pnpm 之所以不只使用软链接，是因为软链接有一些缺点：

1. 软链接会占用更多的硬盘空间：软链接会在硬盘上创建一个新的文件，它的大小与被链接的文件相同，这样就会占用更多的硬盘空间。

2. 软链接会导致性能下降：软链接需要在运行时进行解析，这会导致一定的性能下降。

3. 软链接可能会出现循环链接：如果两个文件相互软链接，就会形成循环链接，这会导致一些问题。

因此，pnpm 使用了类似于硬链接的方式，将依赖包存储在一个共享的位置，然后使用符号链接将它们链接到每个项目中。这种方式可以减少硬盘空间的使用，提高性能，并避免循环链接的问题。

尽管软链接可以减少磁盘空间的占用，但是仅使用软链接会存在一些问题。首先，软链接只能在不同文件系统之间使用，这意味着如果开发者在不同的文件系统之间移动文件，软链接就会失效。其次，软链接还可能导致一些应用程序的兼容性问题，因为有些应用程序可能不支持软链接。

因此，pnpm 选择同时支持软链接和硬链接两种方式。对于在同一文件系统内的依赖，pnpm 使用硬链接，这样就可以减少磁盘空间的占用，同时保证依赖在同一文件系统内的兼容性。对于在不同文件系统内的依赖，pnpm 使用软链接，这样就可以跨越不同的文件系统，并避免由于文件移动而导致的软链接失效的问题。

综上所述，pnpm 之所以不只使用软链接，是因为软链接存在一些局限性和兼容性，同时硬链接可以有效减少磁盘空间占用，因此在不同的情况下选择最适合的链接方式，可以更好地平衡不同的需求。